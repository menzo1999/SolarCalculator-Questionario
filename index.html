<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bertuzzi Energy - Solar Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .hero-overlay {
            background: linear-gradient(to right, rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.4), transparent);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes zoomIn95 {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        .animate-fadeInDown {
            animation: fadeInDown 0.6s ease-out;
        }
        .animate-zoomIn95 {
            animation: zoomIn95 0.3s ease-out;
        }
        .checkbox-custom:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root" class="min-h-screen flex flex-col"></div>

    <script>
    // ==================== CONSTANTS ====================
    const PARAMS = {
        valoreAcquistoEnergia: 0.28,
        percentualeAutoconsumo: 0.65,
        percentualeAutoconsumoStorage: 0.95,
        tariffaRitiroDedicato: 0.11,
        prezzoStorage: 500,
        potenzaModulo: 450
    };

    const FASCE_CONSUMO = [
        { min: 0, max: 3600, nome: "Impianto 3 kWp", kWp: 3.15, nModuli: 7, prezzoNetto: 5000 },
        { min: 3601, max: 4800, nome: "Impianto 4 kWp", kWp: 4.05, nModuli: 9, prezzoNetto: 6300 },
        { min: 4801, max: 6000, nome: "Impianto 5 kWp", kWp: 4.95, nModuli: 11, prezzoNetto: 7000 },
        { min: 6001, max: 7200, nome: "Impianto 6 kWp", kWp: 6.3, nModuli: 14, prezzoNetto: 7500 },
        { min: 7201, max: 999999, nome: "Impianto 8 kWp", kWp: 7.65, nModuli: 17, prezzoNetto: 12500 }
    ];

    const ACCUMULO_CONFIG = {
        '0-3600': 5,
        '3601-4800': 5,
        '4801-6000': 5,
        '6001-7200': 5,
        '7201+': 15
    };

    const PREZZI_CON_ACCUMULO = {
        '0-3600': { prezzoNetto: 7500 },
        '3601-4800': { prezzoNetto: 8800 },
        '4801-6000': { prezzoNetto: 9500 },
        '6001-7200': { prezzoNetto: 10000 },
        '7201+': { prezzoNetto: 15000 }
    };

    const PRODUZIONE_KWH_KWP = {
        nord: { sud: 1250, est: 1150, ovest: 1150, nord: 950 },
        centro: { sud: 1300, est: 1200, ovest: 1200, nord: 1000 },
        sud: { sud: 1450, est: 1300, ovest: 1300, nord: 1100 }
    };

    const RATE_FINDOMESTIC = {
        '0-3600': { senzaStorage: 74.3, conStorage: 111.4 },
        '3601-4800': { senzaStorage: 93.6, conStorage: 130.7 },
        '4801-6000': { senzaStorage: 104, conStorage: 141.1 },
        '6001-7200': { senzaStorage: 111.4, conStorage: 148.5 },
        '7201+': { senzaStorage: 187.5, conStorage: 222.8 }
    };

    const REGIONI_PER_AREA = {
        nord: ['Emilia-Romagna', 'Lombardia', 'Veneto', 'Piemonte', 'Liguria', 'Trentino-Alto Adige', 'Friuli-Venezia Giulia', "Valle d'Aosta"],
        centro: ['Toscana', 'Marche', 'Umbria', 'Lazio', 'Abruzzo', 'Molise'],
        sud: ['Campania', 'Puglia', 'Basilicata', 'Calabria', 'Sicilia', 'Sardegna']
    };

    const SURPLUS_TRASFERTA = {
        'Emilia-Romagna': 0, 'Toscana': 5, 'Marche': 5, 'Veneto': 5, 'Lombardia': 5,
        'Liguria': 8, 'Piemonte': 8, 'Trentino-Alto Adige': 8, 'Umbria': 8, 'Lazio': 8,
        'Abruzzo': 10, 'Molise': 10, 'Campania': 10, 'Puglia': 10, 'Basilicata': 10,
        'Calabria': 10, 'Sicilia': 10, 'Sardegna': 10, 'Friuli-Venezia Giulia': 10, "Valle d'Aosta": 10
    };

    // ==================== STATE ====================
    let currentSection = 'hero';
    let calculationResults = null;
    let formData = {
        tipoCliente: 'privato',
        area: '',
        regione: '',
        consumo: 3500,
        tipoFornitura: 'monofase',
        profiloConsumi: 'diurno',
        esposizione: 'sud',
        tipoTetto: 'falde'
    };
    let customerData = {
        nome: '',
        cognome: '',
        email: '',
        telefono: '',
        indirizzo: '',
        citta: '',
        cap: '',
        accettato: false
    };

    // ==================== SOLAR LOGIC ====================
    function calculateSolar(input) {
        const fascia = FASCE_CONSUMO.find(f => input.consumo >= f.min && input.consumo <= f.max);
        if (!fascia) throw new Error('Consumo fuori range');

        let fasciaKey;
        if (input.consumo <= 3600) fasciaKey = '0-3600';
        else if (input.consumo <= 4800) fasciaKey = '3601-4800';
        else if (input.consumo <= 6000) fasciaKey = '4801-6000';
        else if (input.consumo <= 7200) fasciaKey = '6001-7200';
        else fasciaKey = '7201+';

        const conStorage = input.profiloConsumi === 'serale';
        const accumuloKWh = conStorage ? ACCUMULO_CONFIG[fasciaKey] : 0;

        const produzioneKWhKWp = PRODUZIONE_KWH_KWP[input.area][input.esposizione];
        const produzioneAnnua = Math.round(fascia.kWp * produzioneKWhKWp);

        const percAutoconsumo = conStorage ? PARAMS.percentualeAutoconsumoStorage : PARAMS.percentualeAutoconsumo;
        const energiaAutoconsumata = Math.round(produzioneAnnua * percAutoconsumo);
        const energiaImmessaRete = produzioneAnnua - energiaAutoconsumata;

        const risparmioAutoconsumo = Math.round(energiaAutoconsumata * PARAMS.valoreAcquistoEnergia);
        const ritiroDedicato = Math.round(energiaImmessaRete * PARAMS.tariffaRitiroDedicato);
        const risparmioTotaleAnnuo = risparmioAutoconsumo + ritiroDedicato;

        let prezzoNettoBase = conStorage ? PREZZI_CON_ACCUMULO[fasciaKey].prezzoNetto : fascia.prezzoNetto;
        const aliquotaIVA = input.tipoCliente === 'privato' ? 0.1 : 0.22;

        const percentualeSurplus = SURPLUS_TRASFERTA[input.regione] || 0;
        const costoTrasferta = Math.round(prezzoNettoBase * (percentualeSurplus / 100));
        const prezzoFinaleNetto = prezzoNettoBase + costoTrasferta;
        const prezzoIVA = Math.round(prezzoFinaleNetto * (1 + aliquotaIVA));

        const detrazione50 = Math.round(prezzoIVA * 0.5);
        const detrazioneAnnuale = Math.round(detrazione50 / 10);
        const risparmioConDetrazione = risparmioTotaleAnnuo + detrazioneAnnuale;

        const rientroInvestimento = prezzoIVA / risparmioConDetrazione;

        const rataFindomestic = conStorage ? RATE_FINDOMESTIC[fasciaKey].conStorage : RATE_FINDOMESTIC[fasciaKey].senzaStorage;
        const rataAnnuale = Math.round(rataFindomestic * 12);
        const superficieMinima = Math.round(fascia.nModuli * 2.5);

        return {
            ...input,
            fasciaKey,
            nomeImpianto: fascia.nome,
            kWp: fascia.kWp,
            nModuli: fascia.nModuli,
            accumuloKWh,
            conStorage,
            produzioneKWhKWp,
            produzioneAnnua,
            percAutoconsumo: Math.round(percAutoconsumo * 100),
            energiaAutoconsumata,
            energiaImmessaRete,
            risparmioAutoconsumo,
            ritiroDedicato,
            risparmioTotaleAnnuo,
            prezzoNetto: prezzoNettoBase,
            prezzoIVA,
            percentualeSurplus,
            costoTrasferta,
            prezzoFinale: prezzoIVA,
            detrazione50,
            detrazioneAnnuale,
            risparmioConDetrazione,
            rientroInvestimento,
            rataFindomestic,
            rataAnnuale,
            superficieMinima
        };
    }

    // ==================== RENDER FUNCTIONS ====================
    function renderNavbar() {
        if (currentSection !== 'hero') return '';
        return `
            <nav class="fixed top-0 left-0 right-0 z-[100] h-20 flex items-center bg-black/40 backdrop-blur-lg border-b border-white/10 transition-all duration-500 animate-fadeIn">
                <div class="max-w-[1400px] mx-auto px-8 w-full flex justify-between items-center relative">
                    <div class="absolute left-8 top-1/2 -translate-y-1/2 cursor-pointer transition-transform duration-500 hover:scale-105" onclick="navigateTo('hero')">
                        <img src="https://i.imgur.com/htc01SE.png" alt="Bertuzzi Energy Logo" class="w-[200px] md:w-[280px] h-auto object-contain drop-shadow-[0_10px_30px_rgba(0,0,0,0.5)]" />
                    </div>
                    <div class="w-[200px] md:w-[280px]"></div>
                    <button onclick="navigateTo('form')" class="bg-blue-500 text-white px-8 py-3 rounded-full font-bold text-sm md:text-base shadow-lg shadow-blue-500/20 hover:bg-blue-600 hover:-translate-y-0.5 active:scale-95 transition-all min-w-[140px] md:min-w-[180px]">
                        Inizia Ora
                    </button>
                </div>
            </nav>
        `;
    }

    function renderHero() {
        return `
            <section class="relative h-screen w-full overflow-hidden flex items-center justify-center">
                <video class="absolute inset-0 w-full h-full object-cover" autoplay muted loop playsinline>
                    <source src="https://solar.huawei.com/admin/asset/v1/pro/view/ce3e98aef3b241989f88726a4e507b2c.mp4" type="video/mp4" />
                </video>
                <div class="absolute inset-0 hero-overlay"></div>
                
                <div class="relative z-10 max-w-[1400px] w-full px-8 text-white">
                    <div class="max-w-4xl">
                        <h1 class="text-5xl md:text-7xl lg:text-8xl font-black leading-[1.1] mb-8 animate-fadeInDown">
                            Energia Pulita, <br />
                            <span class="text-blue-400">Futuro Intelligente.</span>
                        </h1>
                        <p class="text-lg md:text-xl lg:text-2xl text-slate-300 mb-12 max-w-2xl leading-relaxed opacity-90">
                            Scopri il potenziale del tuo tetto con il nostro calcolatore avanzato. 
                            Bertuzzi Energy trasforma il sole in risparmio immediato per la tua casa o azienda.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-6">
                            <button onclick="navigateTo('form')" class="px-10 py-4 bg-blue-500 text-white rounded-full font-bold text-lg flex items-center justify-center gap-3 shadow-2xl shadow-blue-500/30 hover:bg-blue-600 hover:scale-105 transition-all">
                                Inizia la Simulazione
                                <svg class="w-6 h-6 stroke-current stroke-2 fill-none" viewBox="0 0 24 24">
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                    <polyline points="12 5 19 12 12 19"></polyline>
                                </svg>
                            </button>
                            <button onclick="window.open('https://www.bertuzzienergy.com/chi-siamo', '_blank')" class="px-10 py-4 bg-white/10 text-white border border-white/30 backdrop-blur-md rounded-full font-bold text-lg hover:bg-white/20 transition-all">
                                Chi Siamo
                            </button>
                        </div>
                    </div>
                </div>

                <div class="absolute bottom-10 left-1/2 -translate-x-1/2 animate-bounce opacity-50">
                    <svg class="w-6 h-6 stroke-white stroke-2 fill-none" viewBox="0 0 24 24">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </section>
        `;
    }

    function renderForm() {
        const currentRegions = formData.area ? REGIONI_PER_AREA[formData.area] : [];
        const regionOptions = currentRegions.map(reg => `<option class="text-slate-900" value="${reg}" ${formData.regione === reg ? 'selected' : ''}>${reg}</option>`).join('');

        return `
            <section class="relative min-h-screen w-full flex flex-col items-center pt-24 md:pt-32 pb-12 px-4 md:px-8 overflow-x-hidden">
                <video class="absolute inset-0 w-full h-full object-cover fixed" autoplay muted loop playsinline>
                    <source src="https://solar.huawei.com/admin/asset/v1/pro/view/ce3e98aef3b241989f88726a4e507b2c.mp4" type="video/mp4" />
                </video>
                <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px] fixed"></div>

                <div class="absolute top-10 left-8 -translate-y-1/2 z-20 cursor-pointer transition-transform duration-500 hover:scale-105" onclick="navigateTo('hero')">
                    <img src="https://i.imgur.com/htc01SE.png" alt="Bertuzzi Energy" class="w-[200px] md:w-[280px] h-auto object-contain drop-shadow-[0_10px_30px_rgba(0,0,0,0.5)]" />
                </div>

                <div class="relative z-10 max-w-4xl w-full animate-fadeIn">
                    <div class="text-center mb-8">
                        <h2 class="text-4xl md:text-5xl lg:text-6xl font-black text-white mb-2 tracking-tight">
                            Configura il tuo <span class="text-blue-400">Impianto</span>
                        </h2>
                        <p class="text-xs md:text-sm text-blue-300 font-bold uppercase tracking-[0.4em] opacity-90">Personalizza la tua energia</p>
                    </div>

                    <div class="bg-white/10 backdrop-blur-3xl rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-12 shadow-[0_30px_60px_-12px_rgba(0,0,0,0.5)] border border-white/20">
                        <form id="solarForm" class="space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                                
                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Tipologia Cliente</label>
                                    <select name="tipoCliente" onchange="updateFormData(event)" class="bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white focus:border-blue-400 focus:bg-black/40 outline-none transition-all cursor-pointer appearance-none">
                                        <option class="text-slate-900" value="privato" ${formData.tipoCliente === 'privato' ? 'selected' : ''}>Privato</option>
                                        <option class="text-slate-900" value="azienda" ${formData.tipoCliente === 'azienda' ? 'selected' : ''}>Azienda</option>
                                    </select>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Area Geografica</label>
                                    <select name="area" required onchange="updateFormData(event); updateRegions()" class="bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white focus:border-blue-400 focus:bg-black/40 outline-none transition-all cursor-pointer appearance-none">
                                        <option class="text-slate-900" value="">Seleziona area</option>
                                        <option class="text-slate-900" value="nord" ${formData.area === 'nord' ? 'selected' : ''}>Nord Italia</option>
                                        <option class="text-slate-900" value="centro" ${formData.area === 'centro' ? 'selected' : ''}>Centro Italia</option>
                                        <option class="text-slate-900" value="sud" ${formData.area === 'sud' ? 'selected' : ''}>Sud Italia e Isole</option>
                                    </select>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Regione</label>
                                    <select name="regione" id="regioneSelect" required ${!formData.area ? 'disabled' : ''} onchange="updateFormData(event)" class="bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white focus:border-blue-400 focus:bg-black/40 outline-none transition-all disabled:opacity-20 disabled:cursor-not-allowed cursor-pointer appearance-none">
                                        <option class="text-slate-900" value="">Seleziona regione</option>
                                        ${regionOptions}
                                    </select>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Consumo Annuo (kWh)</label>
                                    <div class="relative">
                                        <input type="number" name="consumo" value="${formData.consumo}" onchange="updateFormData(event)" placeholder="es. 3500" required class="w-full bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white placeholder:text-white/20 focus:border-blue-400 focus:bg-black/40 outline-none transition-all" />
                                        <button type="button" onclick="openEstimateModal()" class="absolute right-3 top-1/2 -translate-y-1/2 text-[9px] font-black uppercase tracking-widest text-blue-400 hover:text-white bg-blue-500/10 px-3 py-2 rounded-lg transition-all border border-blue-400/20">
                                            AIUTO
                                        </button>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Profilo Consumi</label>
                                    <select name="profiloConsumi" onchange="updateFormData(event)" class="bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white focus:border-blue-400 focus:bg-black/40 outline-none transition-all cursor-pointer appearance-none">
                                        <option class="text-slate-900" value="diurno" ${formData.profiloConsumi === 'diurno' ? 'selected' : ''}>Diurno (Sempre a casa)</option>
                                        <option class="text-slate-900" value="serale" ${formData.profiloConsumi === 'serale' ? 'selected' : ''}>Serale (Solo sera/notte)</option>
                                    </select>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Esposizione Tetto</label>
                                    <select name="esposizione" onchange="updateFormData(event)" class="bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white focus:border-blue-400 focus:bg-black/40 outline-none transition-all cursor-pointer appearance-none">
                                        <option class="text-slate-900" value="sud" ${formData.esposizione === 'sud' ? 'selected' : ''}>Sud (Ottimale)</option>
                                        <option class="text-slate-900" value="est" ${formData.esposizione === 'est' ? 'selected' : ''}>Est</option>
                                        <option class="text-slate-900" value="ovest" ${formData.esposizione === 'ovest' ? 'selected' : ''}>Ovest</option>
                                        <option class="text-slate-900" value="nord" ${formData.esposizione === 'nord' ? 'selected' : ''}>Nord</option>
                                    </select>
                                </div>
                            </div>

                            <div class="pt-8 border-t border-white/10 flex flex-col sm:flex-row gap-4">
                                <button type="button" onclick="navigateTo('hero')" class="flex-1 px-8 py-4 bg-white/5 text-blue-300 border border-white/10 rounded-xl font-black uppercase tracking-widest text-[10px] hover:bg-white/10 transition-all flex items-center justify-center gap-2">
                                    Indietro
                                </button>
                                <button type="submit" class="flex-[2] px-8 py-4 bg-blue-500 text-white rounded-xl font-black uppercase tracking-widest text-xs flex items-center justify-center gap-3 shadow-xl shadow-blue-500/30 hover:bg-blue-600 hover:-translate-y-1 active:scale-95 transition-all">
                                    Calcola Risparmio
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="estimateModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-blue-900/40 backdrop-blur-sm animate-fadeIn">
                    <div class="absolute inset-0" onclick="closeEstimateModal()"></div>
                    <div class="relative bg-white rounded-[2.5rem] p-10 max-w-lg w-full shadow-2xl animate-zoomIn95">
                        <h3 class="text-2xl font-extrabold text-blue-600 mb-2">Stima il tuo consumo</h3>
                        <p class="text-blue-400 font-medium mb-8">Seleziona il numero di persone in casa per una stima approssimativa del consumo annuo.</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                            <button onclick="selectEstimate(2000)" class="p-6 bg-slate-50 border-2 border-blue-50 rounded-2xl text-center hover:border-blue-500 hover:bg-blue-50 transition-all group">
                                <p class="text-[10px] font-bold text-blue-300 uppercase tracking-widest mb-2 group-hover:text-blue-500">1-2 Persone</p>
                                <p class="text-2xl font-black text-blue-900">2000 <span class="text-sm text-blue-300">kWh</span></p>
                            </button>
                            <button onclick="selectEstimate(3500)" class="p-6 bg-slate-50 border-2 border-blue-50 rounded-2xl text-center hover:border-blue-500 hover:bg-blue-50 transition-all group">
                                <p class="text-[10px] font-bold text-blue-300 uppercase tracking-widest mb-2 group-hover:text-blue-500">3-4 Persone</p>
                                <p class="text-2xl font-black text-blue-900">3500 <span class="text-sm text-blue-300">kWh</span></p>
                            </button>
                            <button onclick="selectEstimate(5000)" class="p-6 bg-slate-50 border-2 border-blue-50 rounded-2xl text-center hover:border-blue-500 hover:bg-blue-50 transition-all group">
                                <p class="text-[10px] font-bold text-blue-300 uppercase tracking-widest mb-2 group-hover:text-blue-500">5-6 Persone</p>
                                <p class="text-2xl font-black text-blue-900">5000 <span class="text-sm text-blue-300">kWh</span></p>
                            </button>
                            <button onclick="selectEstimate(7000)" class="p-6 bg-slate-50 border-2 border-blue-50 rounded-2xl text-center hover:border-blue-500 hover:bg-blue-50 transition-all group">
                                <p class="text-[10px] font-bold text-blue-300 uppercase tracking-widest mb-2 group-hover:text-blue-500">7+ Persone</p>
                                <p class="text-2xl font-black text-blue-900">7000 <span class="text-sm text-blue-300">kWh</span></p>
                            </button>
                        </div>

                        <button onclick="closeEstimateModal()" class="w-full py-4 bg-slate-100 text-blue-400 rounded-2xl font-bold hover:bg-blue-50 transition-all">
                            Annulla
                        </button>
                    </div>
                </div>
            </section>
        `;
    }

    function renderResults() {
        const r = calculationResults;
        if (!r) return '';

        return `
            <section class="relative min-h-screen py-16 md:py-24 px-4 md:px-8 flex flex-col items-center pt-32 md:pt-40 overflow-hidden">
                <video class="absolute inset-0 w-full h-full object-cover fixed" autoplay muted loop playsinline>
                    <source src="https://solar.huawei.com/admin/asset/v1/pro/view/ce3e98aef3b241989f88726a4e507b2c.mp4" type="video/mp4" />
                </video>
                <div class="absolute inset-0 bg-black/60 backdrop-blur-[2px] fixed"></div>

                <div class="absolute top-10 left-8 -translate-y-1/2 z-20 cursor-pointer transition-transform duration-500 hover:scale-105">
                    <img src="https://i.imgur.com/htc01SE.png" alt="Bertuzzi Energy" class="w-[200px] md:w-[280px] h-auto object-contain drop-shadow-[0_10px_30px_rgba(0,0,0,0.5)]" />
                </div>

                <div class="relative z-10 max-w-6xl w-full animate-fadeIn">
                    <div class="bg-white/10 backdrop-blur-3xl rounded-[3rem] p-8 md:p-16 shadow-[0_40px_80px_-15px_rgba(0,0,0,0.6)] border border-white/20">
                        
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-10 mb-16">
                            <div>
                                <h2 class="text-5xl md:text-6xl font-black text-white leading-none mb-3">
                                    Analisi <br />
                                    <span class="text-blue-400">Smart.</span>
                                </h2>
                                <p class="text-blue-300 font-bold uppercase tracking-[0.3em] text-xs">Simulazione Energetica Avanzata</p>
                            </div>
                            <button onclick="generatePDF()" class="bg-blue-600 text-white px-10 py-5 rounded-full font-black uppercase tracking-widest text-[10px] flex items-center gap-4 shadow-2xl shadow-blue-600/40 hover:bg-blue-700 hover:-translate-y-1 active:scale-95 transition-all">
                                Scarica Report PDF
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-16">
                            <div class="bg-blue-600/80 backdrop-blur-md rounded-[2rem] p-8 text-white shadow-xl hover:-translate-y-2 transition-all duration-500 border border-white/10">
                                <p class="text-[10px] font-black uppercase tracking-[0.2em] opacity-80 mb-5">Impianto</p>
                                <h3 class="text-3xl font-black leading-tight">${r.nomeImpianto}</h3>
                            </div>
                            
                            <div class="bg-blue-500/80 backdrop-blur-md rounded-[2rem] p-8 text-white shadow-xl hover:-translate-y-2 transition-all duration-500 border border-white/10">
                                <p class="text-[10px] font-black uppercase tracking-[0.2em] opacity-80 mb-5">Risparmio</p>
                                <h3 class="text-3xl font-black leading-tight mb-2">€ ${r.risparmioTotaleAnnuo.toLocaleString()}</h3>
                                <p class="text-base font-bold opacity-90 text-blue-100">all'anno</p>
                            </div>

                            <div class="bg-blue-400/80 backdrop-blur-md rounded-[2rem] p-8 text-white shadow-xl hover:-translate-y-2 transition-all duration-500 border border-white/10">
                                <p class="text-[10px] font-black uppercase tracking-[0.2em] opacity-80 mb-5">Ammortamento</p>
                                <h3 class="text-3xl font-black leading-tight mb-2">${r.rientroInvestimento.toFixed(1)}</h3>
                                <p class="text-base font-bold opacity-90 text-blue-100">Anni stimati</p>
                            </div>

                            <div class="bg-white/10 backdrop-blur-md rounded-[2rem] p-8 text-white shadow-xl hover:-translate-y-2 transition-all duration-500 border border-white/20">
                                <p class="text-[10px] font-black uppercase tracking-[0.2em] opacity-70 mb-5">Produzione</p>
                                <h3 class="text-3xl font-black leading-tight mb-2">${r.produzioneAnnua.toLocaleString()}</h3>
                                <p class="text-base font-bold opacity-70 text-blue-200">kWh/anno</p>
                            </div>
                        </div>

                        <div class="bg-black/20 backdrop-blur-sm rounded-[2.5rem] p-8 md:p-12 mb-16 border border-white/10">
                            <h4 class="text-[10px] font-black uppercase tracking-[0.3em] text-blue-400 mb-10">Dettagli Impianto & Costi</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-10 gap-y-12">
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black text-blue-300 uppercase tracking-widest">Tecnologia</p>
                                    <p class="text-xl font-black text-white">${r.nModuli} Moduli ${PARAMS.potenzaModulo}W</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black text-blue-300 uppercase tracking-widest">Storage</p>
                                    <p class="text-xl font-black text-white">${r.conStorage ? `${r.accumuloKWh} kWh` : 'Assente'}</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black text-blue-300 uppercase tracking-widest">Efficienza</p>
                                    <p class="text-xl font-black text-white">${r.percAutoconsumo}% Autoconsumo</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black text-blue-300 uppercase tracking-widest">Ingombro</p>
                                    <p class="text-xl font-black text-white">~ ${r.superficieMinima} m²</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black text-blue-400 uppercase tracking-widest">Totale Ivato</p>
                                    <p class="text-xl font-black text-blue-400">€ ${r.prezzoIVA.toLocaleString()}</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black text-blue-300 uppercase tracking-widest">Incentivo 50%</p>
                                    <p class="text-xl font-black text-white">€ ${r.detrazioneAnnuale.toLocaleString()} / anno</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black text-blue-300 uppercase tracking-widest">Rata Findomestic</p>
                                    <p class="text-xl font-black text-white">€ ${r.rataFindomestic.toFixed(2)} / mese</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-[9px] font-black text-blue-400 uppercase tracking-widest">Risparmio Netto</p>
                                    <p class="text-xl font-black text-blue-400">€ ${r.risparmioConDetrazione.toLocaleString()} / anno</p>
                                </div>
                            </div>
                        </div>

                        <div class="pt-10 border-t border-white/10 flex flex-col sm:flex-row justify-between items-center gap-8">
                            <button onclick="navigateTo('form')" class="group text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 hover:text-white flex items-center gap-3 transition-all">
                                <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                                Modifica Dati
                            </button>
                            <button onclick="navigateTo('acceptance')" class="w-full sm:w-auto px-10 py-5 bg-green-500 text-white rounded-full font-black uppercase tracking-widest text-[11px] shadow-2xl shadow-green-500/30 hover:bg-green-600 hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-3">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 13l4 4L19 7"/></svg>
                                Accetta Preventivo
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        `;
    }

    function renderAcceptance() {
        const r = calculationResults;
        if (!r) return '';

        return `
            <section class="relative min-h-screen py-16 md:py-24 px-4 md:px-8 flex flex-col items-center pt-32 md:pt-40 overflow-hidden">
                <video class="absolute inset-0 w-full h-full object-cover fixed" autoplay muted loop playsinline>
                    <source src="https://solar.huawei.com/admin/asset/v1/pro/view/ce3e98aef3b241989f88726a4e507b2c.mp4" type="video/mp4" />
                </video>
                <div class="absolute inset-0 bg-black/60 backdrop-blur-[2px] fixed"></div>

                <div class="absolute top-10 left-8 -translate-y-1/2 z-20 cursor-pointer transition-transform duration-500 hover:scale-105" onclick="navigateTo('hero')">
                    <img src="https://i.imgur.com/htc01SE.png" alt="Bertuzzi Energy" class="w-[200px] md:w-[280px] h-auto object-contain drop-shadow-[0_10px_30px_rgba(0,0,0,0.5)]" />
                </div>

                <div class="relative z-10 max-w-4xl w-full animate-fadeIn">
                    <div class="text-center mb-8">
                        <h2 class="text-4xl md:text-5xl lg:text-6xl font-black text-white mb-2 tracking-tight">
                            Accetta il <span class="text-green-400">Preventivo</span>
                        </h2>
                        <p class="text-xs md:text-sm text-green-300 font-bold uppercase tracking-[0.4em] opacity-90">Compila i tuoi dati per confermare</p>
                    </div>

                    <div class="bg-white/10 backdrop-blur-3xl rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-12 shadow-[0_30px_60px_-12px_rgba(0,0,0,0.5)] border border-white/20">
                        
                        <!-- Riepilogo Preventivo -->
                        <div class="bg-green-500/20 border border-green-400/30 rounded-2xl p-6 mb-10">
                            <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-green-400 mb-4">Riepilogo Preventivo</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-white">
                                <div>
                                    <p class="text-[9px] font-bold text-green-300 uppercase">Impianto</p>
                                    <p class="text-lg font-black">${r.nomeImpianto}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] font-bold text-green-300 uppercase">Potenza</p>
                                    <p class="text-lg font-black">${r.kWp} kWp</p>
                                </div>
                                <div>
                                    <p class="text-[9px] font-bold text-green-300 uppercase">Totale IVA incl.</p>
                                    <p class="text-lg font-black text-green-400">€ ${r.prezzoIVA.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] font-bold text-green-300 uppercase">Risparmio/anno</p>
                                    <p class="text-lg font-black">€ ${r.risparmioTotaleAnnuo.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>

                        <form id="acceptanceForm" class="space-y-8">
                            <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-blue-400 mb-6">I tuoi dati</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Nome *</label>
                                    <input type="text" name="nome" value="${customerData.nome}" onchange="updateCustomerData(event)" required placeholder="Mario" class="w-full bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white placeholder:text-white/30 focus:border-green-400 focus:bg-black/40 outline-none transition-all" />
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Cognome *</label>
                                    <input type="text" name="cognome" value="${customerData.cognome}" onchange="updateCustomerData(event)" required placeholder="Rossi" class="w-full bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white placeholder:text-white/30 focus:border-green-400 focus:bg-black/40 outline-none transition-all" />
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Email *</label>
                                    <input type="email" name="email" value="${customerData.email}" onchange="updateCustomerData(event)" required placeholder="mario.rossi@email.com" class="w-full bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white placeholder:text-white/30 focus:border-green-400 focus:bg-black/40 outline-none transition-all" />
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Telefono *</label>
                                    <input type="tel" name="telefono" value="${customerData.telefono}" onchange="updateCustomerData(event)" required placeholder="+39 333 1234567" class="w-full bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white placeholder:text-white/30 focus:border-green-400 focus:bg-black/40 outline-none transition-all" />
                                </div>

                                <div class="flex flex-col gap-2 md:col-span-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Indirizzo Installazione *</label>
                                    <input type="text" name="indirizzo" value="${customerData.indirizzo}" onchange="updateCustomerData(event)" required placeholder="Via Roma 123" class="w-full bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white placeholder:text-white/30 focus:border-green-400 focus:bg-black/40 outline-none transition-all" />
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">Città *</label>
                                    <input type="text" name="citta" value="${customerData.citta}" onchange="updateCustomerData(event)" required placeholder="Milano" class="w-full bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white placeholder:text-white/30 focus:border-green-400 focus:bg-black/40 outline-none transition-all" />
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-300 ml-1">CAP *</label>
                                    <input type="text" name="cap" value="${customerData.cap}" onchange="updateCustomerData(event)" required placeholder="20100" class="w-full bg-black/20 border border-white/20 rounded-xl p-4 font-bold text-white placeholder:text-white/30 focus:border-green-400 focus:bg-black/40 outline-none transition-all" />
                                </div>
                            </div>

                            <!-- Checkbox Accettazione -->
                            <div class="pt-8 border-t border-white/10">
                                <label class="flex items-start gap-4 cursor-pointer group">
                                    <input type="checkbox" name="accettato" id="accettazioneCheckbox" onchange="updateCustomerData(event)" class="mt-1 w-6 h-6 rounded-lg border-2 border-white/30 bg-transparent checked:bg-green-500 checked:border-green-500 cursor-pointer transition-all" required />
                                    <span class="text-sm text-white/80 leading-relaxed group-hover:text-white transition-all">
                                        Dichiaro di aver preso visione del preventivo e di accettare le condizioni proposte. 
                                        Autorizzo Bertuzzi Energy a contattarmi per procedere con il sopralluogo e l'installazione dell'impianto fotovoltaico.
                                        <span class="text-green-400 font-bold">*</span>
                                    </span>
                                </label>
                            </div>

                            <div class="pt-8 flex flex-col sm:flex-row gap-4">
                                <button type="button" onclick="navigateTo('results')" class="flex-1 px-8 py-4 bg-white/5 text-blue-300 border border-white/10 rounded-xl font-black uppercase tracking-widest text-[10px] hover:bg-white/10 transition-all flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                                    Torna al Preventivo
                                </button>
                                <button type="submit" class="flex-[2] px-8 py-5 bg-green-500 text-white rounded-xl font-black uppercase tracking-widest text-xs flex items-center justify-center gap-3 shadow-xl shadow-green-500/30 hover:bg-green-600 hover:-translate-y-1 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                    Invia Accettazione
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        `;
    }

    function renderFooter() {
        return `
            <footer class="bg-[#1e3a5f] text-white pt-16 pb-12">
                <div class="max-w-[1400px] mx-auto px-8 grid grid-cols-1 md:grid-cols-3 gap-12">
                    <div class="space-y-6">
                        <h3 class="text-base font-black tracking-widest uppercase">Bertuzzi Energy</h3>
                        <p class="text-sm text-slate-300 leading-relaxed max-w-xs">
                            Bertuzzi Energy è un'azienda leader nel settore delle soluzioni energetiche e di sicurezza.
                        </p>
                        <p class="text-sm font-bold text-slate-400">P.I. IT03111391201</p>
                    </div>

                    <div class="space-y-6">
                        <h3 class="text-base font-black tracking-widest uppercase">Contatti</h3>
                        <div class="text-sm text-slate-300 space-y-2">
                            <p>Via Molino Rosso 9<br />IMOLA (BO) 40026</p>
                            <p>Tel: 0542-367063<br />Tel: 0542-367064</p>
                            <p>Email: info@bertuzzienergy.it</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <h3 class="text-base font-black tracking-widest uppercase">Legal</h3>
                        <div class="flex flex-col gap-3">
                            <a href="#" class="text-sm text-slate-300 hover:text-white hover:underline transition-all">Terms & Conditions</a>
                            <a href="#" class="text-sm text-slate-300 hover:text-white hover:underline transition-all">Privacy Policy</a>
                            <a href="#" class="text-sm text-slate-300 hover:text-white hover:underline transition-all">Cookie Policy</a>
                        </div>
                    </div>
                </div>
                <div class="max-w-[1400px] mx-auto px-8 mt-16 pt-8 border-t border-white/10 text-center text-xs text-slate-400">
                    &copy; ${new Date().getFullYear()} Bertuzzi Energy S.R.L. Tutti i diritti riservati.
                </div>
            </footer>
        `;
    }

    // ==================== APP FUNCTIONS ====================
    function navigateTo(section) {
        currentSection = section;
        render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateFormData(event) {
        const { name, value } = event.target;
        formData[name] = name === 'consumo' ? Number(value) : value;
    }

    function updateCustomerData(event) {
        const { name, value, type, checked } = event.target;
        customerData[name] = type === 'checkbox' ? checked : value;
    }

    function updateRegions() {
        formData.regione = '';
        render();
    }

    function openEstimateModal() {
        document.getElementById('estimateModal').classList.remove('hidden');
    }

    function closeEstimateModal() {
        document.getElementById('estimateModal').classList.add('hidden');
    }

    function selectEstimate(value) {
        formData.consumo = value;
        closeEstimateModal();
        render();
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        if (!formData.area || !formData.regione || !formData.consumo) {
            alert('Completa tutti i campi obbligatori');
            return;
        }
        calculationResults = calculateSolar(formData);
        navigateTo('results');
    }

    function handleAcceptanceSubmit(e) {
        e.preventDefault();
        
        if (!customerData.accettato) {
            alert('Devi accettare le condizioni per procedere');
            return;
        }

        const r = calculationResults;
        const c = customerData;
        const today = new Date().toLocaleDateString('it-IT');

        // Costruisci il corpo dell'email
        const subject = encodeURIComponent(`Accettazione Preventivo Fotovoltaico - ${c.nome} ${c.cognome}`);
        
        const body = encodeURIComponent(`
ACCETTAZIONE PREVENTIVO FOTOVOLTAICO
=====================================
Data: ${today}

DATI CLIENTE
------------
Nome: ${c.nome} ${c.cognome}
Email: ${c.email}
Telefono: ${c.telefono}
Indirizzo: ${c.indirizzo}
Città: ${c.citta}
CAP: ${c.cap}
Regione: ${r.regione}

DETTAGLI IMPIANTO
-----------------
Tipologia: ${r.tipoCliente === 'privato' ? 'Privato' : 'Azienda'}
Impianto: ${r.nomeImpianto}
Potenza: ${r.kWp} kWp
Moduli: ${r.nModuli} x ${PARAMS.potenzaModulo}W
Storage: ${r.conStorage ? r.accumuloKWh + ' kWh' : 'Non incluso'}
Esposizione: ${r.esposizione.toUpperCase()}
Superficie richiesta: ~${r.superficieMinima} m²

ANALISI ECONOMICA
-----------------
Consumo annuo dichiarato: ${r.consumo.toLocaleString()} kWh
Produzione stimata: ${r.produzioneAnnua.toLocaleString()} kWh/anno
Autoconsumo: ${r.percAutoconsumo}%
Risparmio annuo: € ${r.risparmioTotaleAnnuo.toLocaleString()}
Detrazione 50%: € ${r.detrazioneAnnuale.toLocaleString()}/anno
Rientro investimento: ${r.rientroInvestimento.toFixed(1)} anni

PREZZO
------
Totale (IVA inclusa): € ${r.prezzoIVA.toLocaleString()}
Rata Findomestic: € ${r.rataFindomestic.toFixed(2)}/mese

=====================================
Il cliente ha accettato il preventivo e autorizza il contatto per il sopralluogo.
        `.trim());

        // Apri mailto
        window.location.href = `mailto:info@bertuzzienergy.it?subject=${subject}&body=${body}`;
        
        // Mostra conferma
        setTimeout(() => {
            alert('Grazie per aver accettato il preventivo!\n\nSi aprirà il tuo client email per inviare la conferma a Bertuzzi Energy.\n\nVerrai ricontattato al più presto per fissare il sopralluogo.');
        }, 500);
    }

    // ==================== PDF GENERATION ====================
    async function generatePDF() {
        const r = calculationResults;
        const today = new Date().toLocaleDateString('it-IT');
        const refNumber = `PV-${Date.now().toString().slice(-6)}`;
        
        // URL immagini prodotto
        const inverterImg = 'https://i.imgur.com/ADdp7Pc.png';
        const storageImg = 'https://i.imgur.com/X5zdKSU.png';
        
        // Crea il template HTML per il PDF
        const pdfTemplate = document.createElement('div');
        pdfTemplate.id = 'pdf-template';
        pdfTemplate.style.cssText = 'position: fixed; left: -9999px; top: 0; width: 800px; background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%); font-family: Inter, sans-serif; padding: 0; box-sizing: border-box;';
        
        // Sezione prodotti dinamica
        const productSection = r.conStorage ? `
            <!-- Sezione Prodotti - Con Storage -->
            <div style="background: rgba(255,255,255,0.03); border-radius: 20px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.08);">
                <p style="color: #60a5fa; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 3px; margin: 0 0 20px 0; text-align: center;">Componenti del tuo impianto</p>
                <div style="display: flex; justify-content: center; align-items: center; gap: 40px;">
                    <div style="text-align: center;">
                        <div style="background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(59,130,246,0.05) 100%); border-radius: 16px; padding: 20px; border: 1px solid rgba(59,130,246,0.2); margin-bottom: 12px;">
                            <img src="${inverterImg}" style="width: 140px; height: auto; display: block;" crossorigin="anonymous" />
                        </div>
                        <p style="color: white; font-size: 13px; font-weight: 700; margin: 0 0 4px 0;">Inverter Huawei</p>
                        <p style="color: #93c5fd; font-size: 11px; margin: 0;">${r.nomeImpianto}</p>
                    </div>
                    <div style="color: #3b82f6; font-size: 28px; font-weight: 300;">+</div>
                    <div style="text-align: center;">
                        <div style="background: linear-gradient(135deg, rgba(34,197,94,0.15) 0%, rgba(34,197,94,0.05) 100%); border-radius: 16px; padding: 20px; border: 1px solid rgba(34,197,94,0.2); margin-bottom: 12px;">
                            <img src="${storageImg}" style="width: 140px; height: auto; display: block;" crossorigin="anonymous" />
                        </div>
                        <p style="color: white; font-size: 13px; font-weight: 700; margin: 0 0 4px 0;">Batteria Storage</p>
                        <p style="color: #86efac; font-size: 11px; margin: 0;">${r.accumuloKWh} kWh</p>
                    </div>
                </div>
            </div>
        ` : `
            <!-- Sezione Prodotti - Solo Inverter -->
            <div style="background: rgba(255,255,255,0.03); border-radius: 20px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.08);">
                <p style="color: #60a5fa; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 3px; margin: 0 0 20px 0; text-align: center;">Componente principale</p>
                <div style="display: flex; justify-content: center; align-items: center;">
                    <div style="text-align: center;">
                        <div style="background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(59,130,246,0.05) 100%); border-radius: 16px; padding: 25px; border: 1px solid rgba(59,130,246,0.2); margin-bottom: 12px;">
                            <img src="${inverterImg}" style="width: 180px; height: auto; display: block;" crossorigin="anonymous" />
                        </div>
                        <p style="color: white; font-size: 14px; font-weight: 700; margin: 0 0 4px 0;">Inverter Huawei</p>
                        <p style="color: #93c5fd; font-size: 12px; margin: 0;">${r.nomeImpianto}</p>
                    </div>
                </div>
            </div>
        `;
        
        pdfTemplate.innerHTML = `
            <!-- Logo centrato in alto -->
            <div style="padding: 5px 30px 0 30px; text-align: center;">
                <img src="https://i.imgur.com/htc01SE.png" style="width: 280px; height: auto; display: inline-block;" crossorigin="anonymous" />
            </div>
            
            <div style="padding: 8px 30px 30px 30px;">
                <!-- Header con titolo e riferimento -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <h1 style="color: white; font-size: 26px; font-weight: 900; margin: 0 0 5px 0;">Preventivo Impianto Fotovoltaico</h1>
                        <p style="color: rgba(147,197,253,0.8); font-size: 12px; margin: 0;">Simulazione personalizzata per ${r.regione}</p>
                    </div>
                    <div style="text-align: right; background: rgba(59,130,246,0.1); padding: 12px 18px; border-radius: 12px; border: 1px solid rgba(59,130,246,0.2);">
                        <p style="color: #93c5fd; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 3px 0;">Riferimento</p>
                        <p style="color: white; font-size: 14px; font-weight: 800; margin: 0;">${refNumber}</p>
                        <p style="color: rgba(147,197,253,0.6); font-size: 10px; margin: 5px 0 0 0;">${today}</p>
                    </div>
                </div>

                <!-- Cards principali -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 16px; padding: 20px; text-align: center;">
                        <p style="color: rgba(255,255,255,0.7); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 8px 0;">Impianto</p>
                        <p style="color: white; font-size: 20px; font-weight: 900; margin: 0;">${r.nomeImpianto}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #0ea5e9 100%); border-radius: 16px; padding: 20px; text-align: center;">
                        <p style="color: rgba(255,255,255,0.7); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 8px 0;">Risparmio</p>
                        <p style="color: white; font-size: 20px; font-weight: 900; margin: 0;">€ ${r.risparmioTotaleAnnuo.toLocaleString()}</p>
                        <p style="color: rgba(255,255,255,0.7); font-size: 10px; margin: 4px 0 0 0;">all'anno</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border-radius: 16px; padding: 20px; text-align: center;">
                        <p style="color: rgba(255,255,255,0.7); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 8px 0;">Ammortamento</p>
                        <p style="color: white; font-size: 20px; font-weight: 900; margin: 0;">${r.rientroInvestimento.toFixed(1)}</p>
                        <p style="color: rgba(255,255,255,0.7); font-size: 10px; margin: 4px 0 0 0;">anni</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                        <p style="color: rgba(255,255,255,0.5); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 8px 0;">Produzione</p>
                        <p style="color: white; font-size: 20px; font-weight: 900; margin: 0;">${r.produzioneAnnua.toLocaleString()}</p>
                        <p style="color: rgba(255,255,255,0.5); font-size: 10px; margin: 4px 0 0 0;">kWh/anno</p>
                    </div>
                </div>

                ${productSection}

                <!-- Sezione Prezzo -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 20px; padding: 25px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p style="color: rgba(255,255,255,0.7); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 4px 0;">A partire da</p>
                        <p style="color: white; font-size: 36px; font-weight: 900; margin: 0; line-height: 1;">€ ${r.rataFindomestic.toFixed(2)} <span style="font-size: 16px; font-weight: 400;">/mese</span></p>
                        <p style="color: rgba(255,255,255,0.5); font-size: 9px; margin: 6px 0 0 0;">Finanziamento Findomestic 84 mesi</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="color: rgba(255,255,255,0.7); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 4px 0;">Prezzo totale</p>
                        <p style="color: white; font-size: 28px; font-weight: 900; margin: 0;">€ ${r.prezzoIVA.toLocaleString()}</p>
                        <p style="color: rgba(255,255,255,0.5); font-size: 10px; margin: 4px 0 0 0;">IVA ${r.tipoCliente === 'privato' ? '10%' : '22%'} inclusa</p>
                    </div>
                </div>

                <!-- Dettagli Tecnici -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);">
                    <p style="color: #60a5fa; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 3px; margin: 0 0 15px 0;">Specifiche Tecniche & Economiche</p>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <p style="color: #93c5fd; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 4px 0;">Tecnologia</p>
                            <p style="color: white; font-size: 13px; font-weight: 800; margin: 0;">${r.nModuli} Moduli ${PARAMS.potenzaModulo}W</p>
                        </div>
                        <div>
                            <p style="color: #93c5fd; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 4px 0;">Storage</p>
                            <p style="color: white; font-size: 13px; font-weight: 800; margin: 0;">${r.conStorage ? r.accumuloKWh + ' kWh' : 'Non incluso'}</p>
                        </div>
                        <div>
                            <p style="color: #93c5fd; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 4px 0;">Autoconsumo</p>
                            <p style="color: white; font-size: 13px; font-weight: 800; margin: 0;">${r.percAutoconsumo}%</p>
                        </div>
                        <div>
                            <p style="color: #93c5fd; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 4px 0;">Superficie</p>
                            <p style="color: white; font-size: 13px; font-weight: 800; margin: 0;">~ ${r.superficieMinima} m²</p>
                        </div>
                        <div>
                            <p style="color: #60a5fa; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 4px 0;">Potenza</p>
                            <p style="color: #60a5fa; font-size: 13px; font-weight: 800; margin: 0;">${r.kWp} kWp</p>
                        </div>
                        <div>
                            <p style="color: #93c5fd; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 4px 0;">Detrazione 50%</p>
                            <p style="color: white; font-size: 13px; font-weight: 800; margin: 0;">€ ${r.detrazioneAnnuale.toLocaleString()}/anno</p>
                        </div>
                        <div>
                            <p style="color: #93c5fd; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 4px 0;">Esposizione</p>
                            <p style="color: white; font-size: 13px; font-weight: 800; margin: 0;">${r.esposizione.charAt(0).toUpperCase() + r.esposizione.slice(1)}</p>
                        </div>
                        <div>
                            <p style="color: #60a5fa; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 4px 0;">Risparmio Netto</p>
                            <p style="color: #60a5fa; font-size: 13px; font-weight: 800; margin: 0;">€ ${r.risparmioConDetrazione.toLocaleString()}/anno</p>
                        </div>
                    </div>
                </div>

                <!-- Note -->
                <div style="margin-bottom: 15px; padding: 12px 15px; background: rgba(255,255,255,0.02); border-radius: 10px; border-left: 3px solid #3b82f6;">
                    <p style="color: rgba(148,163,184,0.8); font-size: 8px; margin: 0 0 2px 0;">* I valori di produzione sono stime basate su dati medi della zona geografica selezionata.</p>
                    <p style="color: rgba(148,163,184,0.8); font-size: 8px; margin: 0 0 2px 0;">* La detrazione fiscale del 50% è ripartita in 10 anni come da normativa vigente.</p>
                    <p style="color: rgba(148,163,184,0.8); font-size: 8px; margin: 0;">* Questo preventivo ha validità 30 giorni dalla data di emissione.</p>
                </div>

                <!-- Footer -->
                <div style="background: #1e3a5f; border-radius: 14px; padding: 18px; text-align: center;">
                    <p style="color: white; font-size: 13px; font-weight: 800; margin: 0 0 6px 0;">BERTUZZI ENERGY S.R.L.</p>
                    <p style="color: rgba(255,255,255,0.7); font-size: 9px; margin: 0 0 2px 0;">Via Molino Rosso 9, 40026 IMOLA (BO) | P.IVA IT03111391201</p>
                    <p style="color: rgba(255,255,255,0.7); font-size: 9px; margin: 0 0 2px 0;">Tel: 0542-367063 / 0542-367064 | Email: info@bertuzzienergy.it</p>
                    <p style="color: #60a5fa; font-size: 10px; font-weight: 600; margin: 0;">www.bertuzzienergy.it</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(pdfTemplate);
        
        // Attendi che le immagini siano caricate
        await new Promise(resolve => setTimeout(resolve, 800));
        
        try {
            // Cattura il template con html2canvas
            const canvas = await html2canvas(pdfTemplate, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#0f172a',
                logging: false
            });
            
            // Crea il PDF
            const { jsPDF } = window.jspdf;
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const imgX = (pdfWidth - imgWidth * ratio) / 2;
            const imgY = 0;
            
            pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
            pdf.save(`Preventivo_Bertuzzi_${r.nomeImpianto.replace(/\s/g, '_')}.pdf`);
            
        } catch (error) {
            console.error('Errore generazione PDF:', error);
            alert('Errore nella generazione del PDF. Riprova.');
        } finally {
            // Rimuovi il template
            document.body.removeChild(pdfTemplate);
        }
    }

    // ==================== MAIN RENDER ====================
    function render() {
        const root = document.getElementById('root');
        let content = '';

        content += renderNavbar();

        if (currentSection === 'hero') {
            content += renderHero();
        } else if (currentSection === 'form') {
            content += renderForm();
        } else if (currentSection === 'results') {
            content += renderResults();
        } else if (currentSection === 'acceptance') {
            content += renderAcceptance();
        }

        content += renderFooter();

        root.innerHTML = content;

        // Attach form submit handlers
        const solarForm = document.getElementById('solarForm');
        if (solarForm) {
            solarForm.addEventListener('submit', handleFormSubmit);
        }
        
        const acceptanceForm = document.getElementById('acceptanceForm');
        if (acceptanceForm) {
            acceptanceForm.addEventListener('submit', handleAcceptanceSubmit);
        }
    }

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
